<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Админ панел | Златарска радња Болесников</title>

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lora:ital,wght@0,400;1,400&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">

  <style>
    :root {
      --gold: #d6b25e;
      --soft-gold: #f1d9a0;
      --bg-deep: #050816;
      --bg-navy: #1e2940;
      --text-light: #f6f3e8;
      --muted: #b3a48a;
      --danger: #ff6b6b;
      --success: #7dd56f;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      font-family: "Montserrat", sans-serif;
      background: radial-gradient(circle at top, var(--bg-navy) 0, var(--bg-deep) 55%, #000 100%);
      color: var(--soft-gold);
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 32px 16px;
    }

    .admin-shell {
      width: 100%;
      max-width: 1080px;
      border-radius: 24px;
      border: 1px solid rgba(214, 178, 94, 0.45);
      background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.06), rgba(5, 8, 22, 0.98));
      box-shadow: 0 28px 80px rgba(0, 0, 0, 0.85);
      padding: 26px 26px 26px;
      position: relative;
      overflow: hidden;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1.1fr);
      gap: 32px;
    }

    .admin-shell::before {
      content: "";
      position: absolute;
      inset: -40% 40% auto -20%;
      background: radial-gradient(circle at top, rgba(214, 178, 94, 0.24), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    @media (max-width: 880px) {
      .admin-shell {
        grid-template-columns: minmax(0, 1fr);
        padding: 22px 18px 24px;
      }
    }

    .admin-header {
      position: relative;
      z-index: 1;
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .admin-brand { display: flex; align-items: center; gap: 12px; }

    .admin-mark {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid rgba(214, 178, 94, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Cinzel", serif;
      color: var(--gold);
      font-size: 20px;
    }

    .admin-brand-text span { display: block; line-height: 1.2; }

    .admin-name {
      font-family: "Cinzel", serif;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      font-size: 14px;
    }

    .admin-sub {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .admin-tagline {
      font-family: "Lora", serif;
      font-size: 13px;
      color: var(--soft-gold);
      text-align: right;
      max-width: 260px;
    }

    @media (max-width: 620px) {
      .admin-header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .admin-tagline { text-align: left; }
    }

    #loginDiv {
      position: relative;
      z-index: 1;
      border-radius: 18px;
      border: 1px solid rgba(214, 178, 94, 0.4);
      background: rgba(5, 8, 22, 0.96);
      padding: 20px 18px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
      align-self: flex-start;
    }

    #loginDiv h2 {
      font-family: "Cinzel", serif;
      font-size: 16px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 14px;
    }

    #loginDiv input {
      width: 100%;
      padding: 9px 11px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid rgba(214, 178, 94, 0.35);
      background: rgba(3, 5, 14, 0.9);
      color: var(--text-light);
      font-size: 13px;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    #loginDiv input::placeholder { color: rgba(243, 236, 220, 0.55); }

    #loginDiv input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 1px rgba(214, 178, 94, 0.45);
    }

    #loginDiv button {
      width: 100%;
      margin-top: 4px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 1px solid var(--gold);
      background: var(--gold);
      color: #050509;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    }

    #loginDiv button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      background: #e0c06e;
    }

    #loginMsg { margin-top: 8px; font-size: 12px; color: var(--danger); min-height: 16px; }

    #productDiv {
      position: relative;
      z-index: 1;
      border-radius: 18px;
      border: 1px solid rgba(214, 178, 94, 0.4);
      background: rgba(5, 8, 22, 0.96);
      padding: 20px 18px 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.8);
      align-self: stretch;
    }

    #productDiv h2 {
      font-family: "Cinzel", serif;
      font-size: 16px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 14px;
    }

    form input, form textarea {
      width: 100%;
      padding: 9px 11px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid rgba(214, 178, 94, 0.35);
      background: rgba(3, 5, 14, 0.9);
      color: var(--text-light);
      font-size: 13px;
      outline: none;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    form textarea { resize: vertical; min-height: 80px; }

    form input::placeholder, form textarea::placeholder { color: rgba(243, 236, 220, 0.55); }

    form input:focus, form textarea:focus {
      border-color: var(--gold);
      box-shadow: 0 0 0 1px rgba(214, 178, 94, 0.45);
    }

    form label { font-size: 12px; color: var(--muted); margin-bottom: 4px; display: inline-block; }

    form button[type="submit"] {
      margin-top: 4px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--gold);
      background: var(--gold);
      color: #050509;
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-weight: 600;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
    }

    form button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.7);
      background: #e0c06e;
    }

    #logout {
      margin-top: 14px;
      padding: 9px 16px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background .2s ease, color .2s ease, border-color .2s ease;
    }

    #logout:hover {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.35);
      color: var(--text-light);
    }

    .admin-note {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.7;
    }

    .admin-note strong { color: var(--soft-gold); font-weight: 600; }

    @media (max-width: 880px) {
      #productDiv { order: 3; }
      #loginDiv { order: 2; }
    }

    #filterDivTitle {
      margin-top: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    #filterDiv {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 14px;
      margin-bottom: 14px;
    }

    #filterDiv label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 999px;
      background: rgba(10, 12, 25, 0.9);
      border: 1px solid rgba(214, 178, 94, 0.25);
      font-size: 12px;
      color: var(--text-light);
      cursor: pointer;
      transition: background .2s ease, border-color .2s ease, transform .15s ease;
    }

    #filterDiv label:hover {
      background: rgba(214, 178, 94, 0.12);
      border-color: var(--gold);
      transform: translateY(-1px);
    }

    #filterDiv input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--gold);
      cursor: pointer;
    }

    .panel-switch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      background: rgba(10, 12, 25, 0.9);
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(214, 178, 94, 0.35);
      flex-wrap: wrap;
    }

    .panel-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: background .2s ease, color .2s ease, transform .1s ease;
      white-space: nowrap;
    }

    .panel-btn:hover { transform: translateY(-1px); color: var(--soft-gold); }

    .panel-btn.active { background: var(--gold); color: #050509; }

    #msgProducts, #msgPigeons, #msgOrders {
      margin-top: 8px;
      font-size: 12px;
      min-height: 16px;
    }

    /* Ordered panel UI */
    .ordered-box {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(214, 178, 94, 0.25);
      background: rgba(3, 5, 14, 0.65);
      padding: 12px;
      max-height: 320px;
      overflow: auto;
    }

    .ordered-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(255,255,255,0.03);
      margin-bottom: 10px;
    }

    .ordered-item:last-child { margin-bottom: 0; }

    .ordered-left { display: grid; gap: 4px; }
    .ordered-title { color: var(--text-light); font-weight: 600; font-size: 13px; }
    .ordered-meta  { color: var(--muted); font-size: 11px; letter-spacing: 0.06em; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      border: 1px solid rgba(214, 178, 94, 0.35);
      color: var(--soft-gold);
      background: rgba(214, 178, 94, 0.08);
      white-space: nowrap;
    }

    .danger-btn {
      margin-top: 10px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255, 107, 107, 0.65);
      background: rgba(255, 107, 107, 0.16);
      color: #ffdede;
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      transition: transform .2s ease, box-shadow .2s ease, background .2s ease;
      width: 100%;
    }

    .danger-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.65);
      background: rgba(255, 107, 107, 0.22);
    }

    .danger-btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
  </style>
</head>
<body>

  <div class="admin-shell">
    <header class="admin-header">
      <div class="admin-brand">
        <div class="admin-mark">Б</div>
        <div class="admin-brand-text">
          <span class="admin-name">БОЛЕСНИКОВ</span>
          <span class="admin-sub">админ панел · интерна зона</span>
        </div>
      </div>
      <p class="admin-tagline">
        Приватна страница за управљање колекцијом накита и такмичарских голубова. Све измене су видљиве на сајту након чувања.
      </p>
    </header>

    <div id="loginDiv">
      <h2>Пријава</h2>
      <p class="admin-note">
        Унесите <strong>админ е-пошту</strong> и <strong>лозинку</strong> да бисте приступили додавању нових производа и голубова.
      </p>
      <input type="email" id="email" placeholder="Админ е-пошта" />
      <input type="password" id="password" placeholder="Лозинка" />
      <button id="loginBtn">Пријави се</button>
      <p id="loginMsg"></p>
    </div>

    <div id="productDiv" style="display:none;">
      <div class="panel-switch">
        <button type="button" class="panel-btn active" id="btnPanelJewelry">Накит</button>
        <button type="button" class="panel-btn" id="btnPanelPigeons">Голубови</button>
        <button type="button" class="panel-btn" id="btnPanelOrders">Поручено</button>
      </div>

      <h2 id="panelTitle">Додај нови производ</h2>
      <p class="admin-note" id="panelNote">
        Овде можете да унесете <strong>назив, опис, цену, слику</strong> и изаберете филтере.
        Након чувања, производ ће се појавити у јавној колекцији на сајту.
      </p>

      <!-- PANEL ZA NAKIT -->
      <div id="jewelryPanel">
        <form id="productForm">
          <input type="text" id="naziv" placeholder="Назив производа" required />
          <textarea id="opis" placeholder="Кратак опис производа" required></textarea>
          <input type="text" id="cena" placeholder="Цена (RSD)" required />
          <input type="text" id="sifra" placeholder="Шифра (интерно за власника)" />


          <label for="slika">Слика производа</label>
          <input type="file" id="slika" accept="image/*" required />

          <div id="filterDivTitle">Означите филтере:</div>
          <div id="filterDiv">
            <label><input type="checkbox" value="prsten"> Прстен</label>
            <label><input type="checkbox" value="ogrlica"> Огрлица</label>
            <label><input type="checkbox" value="narukvica"> Наруквица</label>
           <label><input type="checkbox" value="narukvica"> Наруквица</label>
            <label><input type="checkbox" value="zlatni"> Златни</label>
            <label><input type="checkbox" value="srebrni"> Сребрни</label>
      
          </div>

          <button type="submit">сачувај производ</button>
        </form>

        <p id="msgProducts"></p>
      </div>

      <!-- PANEL ZA GOLUBOVE -->
      <div id="pigeonPanel" style="display:none;">
        <form id="pigeonForm">
          <input type="text" id="pigeonName" placeholder="Име голуба" required />
          <input type="text" id="pigeonYear" placeholder="Годиште (нпр. 2023)" />
          <input type="text" id="pigeonLine" placeholder="Линија (опционо)" />
          <textarea id="pigeonDesc" placeholder="Кратак опис (опционо)"></textarea>

          <label for="pigeonPhoto">Слика голуба</label>
          <input type="file" id="pigeonPhoto" accept="image/*" required />

          <label for="pigeonPedigree">Слика педигреа</label>
          <input type="file" id="pigeonPedigree" accept="image/*" required />

          <button type="submit">сачувај голуба</button>
        </form>

        <p id="msgPigeons"></p>
      </div>

      <!-- PANEL PORUCENO -->
      <div id="ordersPanel" style="display:none;">
        <p class="admin-note">
          Ово су производи који су <strong>поручени</strong> и зато се више не приказују на сајту.
          Када сте сигурни да је све завршено, можете да кликнете <strong>Очисти базу</strong> да се обришу из Firestore базе.
        </p>

        <div class="ordered-box" id="orderedList"></div>

        <button class="danger-btn" id="btnCleanDb" type="button">Очисти базу (обриши све поручене)</button>
        <p id="msgOrders"></p>
      </div>

      <button id="logout">одјава</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyAO-4f5lke0fpB8M5HQY9UEievyoz5w4",
      authDomain: "zlatara-bolesnikov.firebaseapp.com",
      projectId: "zlatara-bolesnikov",
      storageBucket: "zlatara-bolesnikov.firebasestorage.app",
      messagingSenderId: "444327293695",
      appId: "1:444327293695:web:1a83087a7ade3940ffd2ca",
      measurementId: "G-B03TZ5Z1GH"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const loginDiv = document.getElementById("loginDiv");
    const productDiv = document.getElementById("productDiv");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");

    const panelTitle = document.getElementById("panelTitle");
    const panelNote = document.getElementById("panelNote");

    const btnPanelJewelry = document.getElementById("btnPanelJewelry");
    const btnPanelPigeons = document.getElementById("btnPanelPigeons");
    const btnPanelOrders  = document.getElementById("btnPanelOrders");

    const jewelryPanel = document.getElementById("jewelryPanel");
    const pigeonPanel  = document.getElementById("pigeonPanel");
    const ordersPanel  = document.getElementById("ordersPanel");

    const productForm = document.getElementById("productForm");
    const msgProducts = document.getElementById("msgProducts");
    const pigeonForm = document.getElementById("pigeonForm");
    const msgPigeons = document.getElementById("msgPigeons");

    const orderedList = document.getElementById("orderedList");
    const btnCleanDb  = document.getElementById("btnCleanDb");
    const msgOrders   = document.getElementById("msgOrders");

    function setActiveButton(activeBtn) {
      [btnPanelJewelry, btnPanelPigeons, btnPanelOrders].forEach(b => b.classList.remove("active"));
      activeBtn.classList.add("active");
    }

    function showJewelryPanel() {
      setActiveButton(btnPanelJewelry);
      jewelryPanel.style.display = "block";
      pigeonPanel.style.display = "none";
      ordersPanel.style.display = "none";

      panelTitle.textContent = "Додај нови производ";
      panelNote.innerHTML = `
        Овде можете да унесете <strong>назив, опис, цену, слику</strong> и изаберете филтере.
        Након чувања, производ ће се појавити у јавној колекцији на сајту.
      `;
    }

    function showPigeonPanel() {
      setActiveButton(btnPanelPigeons);
      jewelryPanel.style.display = "none";
      pigeonPanel.style.display = "block";
      ordersPanel.style.display = "none";

      panelTitle.textContent = "Додај новог голуба";
      panelNote.innerHTML = `
        Унесите <strong>име голуба, основне податке</strong> и отпремите
        <strong>слику голуба</strong> и <strong>слику педигреа</strong>. Голуб ће се затим појавити
        на страници "Голубови" у делу за продају.
      `;
    }

    async function showOrdersPanel() {
      setActiveButton(btnPanelOrders);
      jewelryPanel.style.display = "none";
      pigeonPanel.style.display = "none";
      ordersPanel.style.display = "block";

      panelTitle.textContent = "Поручени производи";
      panelNote.innerHTML = `
        Преглед поручених производа који су сакривени са сајта.
        <strong>Очисти базу</strong> брише све поручене производе из базе и чисти листу.
      `;

      await loadOrderedList();
    }

    btnPanelJewelry.addEventListener("click", showJewelryPanel);
    btnPanelPigeons.addEventListener("click", showPigeonPanel);
    btnPanelOrders.addEventListener("click", showOrdersPanel);

    // Login
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginMsg.textContent = "";
      } catch (err) {
        loginMsg.textContent = "Грешка при пријави: " + err.message;
      }
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        loginDiv.style.display = "none";
        productDiv.style.display = "block";
        showJewelryPanel();
      } else {
        loginDiv.style.display = "block";
        productDiv.style.display = "none";
      }
    });

    // Cloudinary upload helper
    async function uploadToCloudinary(file) {
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "proizvodi");
      formData.append("cloud_name", "dbbuf9yww");

      const res = await fetch("https://api.cloudinary.com/v1_1/dbbuf9yww/image/upload", {
        method: "POST",
        body: formData
      });

      if (!res.ok) throw new Error("Cloudinary upload failed");
      const data = await res.json();
      return data.secure_url;
    }

    // Dodavanje proizvoda
    productForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgProducts.textContent = "";
      msgProducts.style.color = "#7dd56f";

      const title = document.getElementById("naziv").value;
      const desc = document.getElementById("opis").value;
      const price = document.getElementById("cena").value;
      const code = (document.getElementById("sifra").value || "").trim();
      const imgFile = document.getElementById("slika").files[0];
      const category = Array.from(document.querySelectorAll("#filterDiv input[type='checkbox']:checked"))
        .map(cb => cb.value);

      if (!imgFile) {
        alert("Морате изабрати слику!");
        return;
      }

      try {
        const slikaURL = await uploadToCloudinary(imgFile);

        await addDoc(collection(db, "products"), {
          title: title,
          desc: desc,
          price: parseInt(price),
          category: category,
          img: slikaURL,
          code: code || null,   
          createdAt: new Date()
        });

        msgProducts.style.color = "#7dd56f";
        msgProducts.textContent = "Производ је успешно додат ✅";
        productForm.reset();
      } catch (err) {
        msgProducts.style.color = "#ff6b6b";
        msgProducts.textContent = "Грешка: " + err.message;
      }
    });

    // Dodavanje goluba
    pigeonForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgPigeons.textContent = "";
      msgPigeons.style.color = "#7dd56f";

      const name = document.getElementById("pigeonName").value;
      const year = document.getElementById("pigeonYear").value;
      const line = document.getElementById("pigeonLine").value;
      const desc = document.getElementById("pigeonDesc").value;
      const photoFile = document.getElementById("pigeonPhoto").files[0];
      const pedigreeFile = document.getElementById("pigeonPedigree").files[0];

      if (!photoFile || !pedigreeFile) {
        alert("Морате изабрати слику голуба и слику педигреа!");
        return;
      }

      try {
        const photoURL = await uploadToCloudinary(photoFile);
        const pedigreeURL = await uploadToCloudinary(pedigreeFile);

        await addDoc(collection(db, "pigeons"), {
          name: name,
          year: year || null,
          line: line || null,
          desc: desc || null,
          img: photoURL,
          pedigree: pedigreeURL,
          createdAt: new Date()
        });

        msgPigeons.style.color = "#7dd56f";
        msgPigeons.textContent = "Голуб је успешно додат ✅";
        pigeonForm.reset();
      } catch (err) {
        msgPigeons.style.color = "#ff6b6b";
        msgPigeons.textContent = "Грешка: " + err.message;
      }
    });

    // Logout
    document.getElementById("logout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // ====== PORUCENO LOGIKA ======

    function formatDateMaybe(ts) {
      try {
        if (!ts) return "—";
        // Firestore Timestamp has toDate()
        if (typeof ts.toDate === "function") {
          const d = ts.toDate();
          return d.toLocaleString("sr-RS");
        }
        // if it is Date
        if (ts instanceof Date) return ts.toLocaleString("sr-RS");
        return "—";
      } catch (e) {
        return "—";
      }
    }

    async function loadOrderedList() {
      msgOrders.textContent = "";
      msgOrders.style.color = "#7dd56f";
      orderedList.innerHTML = `<div style="color: var(--muted); font-size: 12px;">Учитавање…</div>`;

      try {
        const snap = await getDocs(collection(db, "ordered_products"));
        const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        if (rows.length === 0) {
          orderedList.innerHTML = `<div style="color: var(--muted); font-size: 12px;">Нема поручених производа.</div>`;
          btnCleanDb.disabled = true;
          return;
        }

        btnCleanDb.disabled = false;

        orderedList.innerHTML = "";
        rows
          .sort((a,b) => {
            const at = a.orderedAt?.toMillis ? a.orderedAt.toMillis() : 0;
            const bt = b.orderedAt?.toMillis ? b.orderedAt.toMillis() : 0;
            return bt - at;
          })
          .forEach(o => {
            const el = document.createElement("div");
            el.className = "ordered-item";
            el.innerHTML = `
              <div class="ordered-left">
                <div class="ordered-title">${(o.title || "Поручен производ")}</div>
                <div class="ordered-meta">ID: ${o.productId || o.id}</div>
                <div class="ordered-meta">Поручено: ${formatDateMaybe(o.orderedAt)}</div>
              </div>
              <div class="badge">сакривено са сајта</div>
            `;
            orderedList.appendChild(el);
          });

      } catch (err) {
        orderedList.innerHTML = "";
        msgOrders.style.color = "#ff6b6b";
        msgOrders.textContent = "Грешка при учитавању: " + err.message;
        btnCleanDb.disabled = true;
      }
    }

    btnCleanDb.addEventListener("click", async () => {
      msgOrders.textContent = "";
      msgOrders.style.color = "#7dd56f";

      const ok = confirm("Да ли сте сигурни? Ово ће обрисати СВЕ поручене производе из базе и очистити листу.");
      if (!ok) return;

      btnCleanDb.disabled = true;
      btnCleanDb.textContent = "Чишћење…";

      try {
        const orderedSnap = await getDocs(collection(db, "ordered_products"));
        const ordered = orderedSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        if (ordered.length === 0) {
          msgOrders.textContent = "Нема поручених производа за брисање.";
          await loadOrderedList();
          return;
        }

        // 1) Obrisi products/{productId}
        for (const o of ordered) {
          const pid = o.productId || o.id;
          if (pid) {
            try {
              await deleteDoc(doc(db, "products", pid));
            } catch (e) {
              console.warn("Није успело брисање products/" + pid, e);
            }
          }
        }

        // 2) Obrisi ordered_products/{id}
        for (const o of ordered) {
          try {
            await deleteDoc(doc(db, "ordered_products", o.id));
          } catch (e) {
            console.warn("Није успело брисање ordered_products/" + o.id, e);
          }
        }

        msgOrders.textContent = "База је очишћена ✅ (поручени производи су обрисани)";
        await loadOrderedList();

      } catch (err) {
        msgOrders.style.color = "#ff6b6b";
        msgOrders.textContent = "Грешка при чишћењу: " + err.message;
      } finally {
        btnCleanDb.disabled = false;
        btnCleanDb.textContent = "Очисти базу (обриши све поручене)";
      }
    });
  </script>
</body>
</html>
